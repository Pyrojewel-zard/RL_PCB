# 01. 脚本启动阶段

## 概述
训练流程从`run.sh`脚本开始，该脚本负责系统资源检测、环境配置和训练调度器的启动。

## 详细流程

### 1.1 系统资源检测
```bash
# 系统资源检测和优化配置
CPU_CORES=$(nproc)                      # 获取CPU核心数
GPU_COUNT=$(nvidia-smi -L 2>/dev/null | wc -l || echo 0)  # 获取GPU数量

echo "=== 系统资源检测 ==="
echo "CPU核心数: $CPU_CORES"
echo "GPU数量: $GPU_COUNT"
```

**功能说明：**
- 自动检测系统CPU核心数
- 检测可用GPU数量
- 显示GPU型号和显存信息

### 1.2 环境变量优化配置
```bash
# 设置环境变量以优化多线程性能
export OMP_NUM_THREADS=$CPU_CORES       # OpenMP线程数
export MKL_NUM_THREADS=$CPU_CORES       # Intel MKL线程数
export NUMEXPR_NUM_THREADS=$CPU_CORES   # NumExpr线程数
export CUDA_VISIBLE_DEVICES=0,1         # 显式设置可见的GPU
```

**优化目的：**
- 充分利用多核CPU进行并行计算
- 优化数学库性能
- 明确指定GPU设备

### 1.3 并行实例数动态计算
```bash
# 根据系统资源动态调整并行实例数
if [ $GPU_COUNT -ge 2 ]; then
    PARALLEL_INSTANCES=$((CPU_CORES / 2))  # 双GPU情况下可以更激进
else
    PARALLEL_INSTANCES=$((CPU_CORES / 4))  # 单GPU情况下保守一些
fi

# 确保至少有2个实例，最多不超过8个
PARALLEL_INSTANCES=$(( PARALLEL_INSTANCES < 2 ? 2 : PARALLEL_INSTANCES ))
PARALLEL_INSTANCES=$(( PARALLEL_INSTANCES > 8 ? 8 : PARALLEL_INSTANCES ))
```

**计算逻辑：**
- 双GPU系统：CPU核心数/2
- 单GPU系统：CPU核心数/4
- 限制范围：2-8个并行实例

### 1.4 二进制工具路径定义
```bash
# 二进制工具路径定义
KICAD_PARSER=${RL_PCB}/bin/kicadParser  # KiCad解析器路径
SA_PCB=${RL_PCB}/bin/sa                 # 模拟退火工具路径
PCB_ROUTER=${RL_PCB}/bin/pcb_router     # PCB布线工具路径
```

**工具说明：**
- `kicadParser`：解析KiCad PCB文件
- `sa`：模拟退火算法工具
- `pcb_router`：PCB布线工具

### 1.5 TensorBoard启动
```bash
# 寻找可用端口
TENSORBOARD_PORT=$(find_available_port 6001 6100)

# 启动TensorBoard监控
tensorboard --logdir ./work/ --host 0.0.0.0 --port $TENSORBOARD_PORT &
```

**功能：**
- 自动寻找可用端口（6001-6100）
- 启动TensorBoard用于训练监控
- 访问地址：`http://localhost:$TENSORBOARD_PORT`

### 1.6 训练调度器启动
```bash
# 启动训练调度器
./scheduler.sh --run_config ${EXP_DIR}/run_config.txt --logfile $EXP_DIR/scheduler.log --instances $PARALLEL_INSTANCES --yes
```

**参数说明：**
- `--run_config`：训练配置文件路径
- `--logfile`：调度器日志文件
- `--instances`：并行实例数
- `--yes`：自动确认执行

## 关键文件

### run.sh
- **位置**：`experiments/00_parameter_exeperiments/run.sh`
- **功能**：主启动脚本，负责环境配置和调度器启动

### scheduler.sh
- **位置**：`src/training/scheduler.sh`
- **功能**：训练调度器，管理并行训练实例

## 输出信息
```
=== 系统资源检测 ===
CPU核心数: 16
GPU数量: 2
设置并行实例数: 8
找到可用端口: 6001
TensorBoard已启动，访问地址: http://localhost:6001
```

## 下一步
进入[02_训练配置解析阶段](./02_训练配置解析阶段.md) 