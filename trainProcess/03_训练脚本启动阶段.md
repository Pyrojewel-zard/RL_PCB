# 03. 训练脚本启动阶段

## 概述
训练脚本启动阶段从`train.py`开始，负责参数解析、环境设置和训练流程的初始化。

## 详细流程

### 3.1 主函数入口
```python
def main():
    args, settings = cmdline_args()  # 解析命令行参数
    
    # 重定向输出（可选）
    if settings["redirect_stdout"] is True:
        redirection_file = os.path.join(settings["tensorboard_dir"],
                                        f"{settings['policy']}_{settings['experiment']}.stdout")
        sys.stdout = open(redirection_file, "w", encoding="utf-8")
    
    # 显示程序信息
    program_info(args.device)
    
    # 多轮训练循环
    for run in range(settings["runs"]):
        settings["run"] = run
        perf_metrics = training_run(settings=settings)
```

### 3.2 命令行参数解析
```python
def cmdline_args():
    parser = argparse.ArgumentParser(
        description="unified argument parser for pcb component training",
        usage="<script-name> -p <pcb_file> --rl_model_type [TD3 | SAC]",
        epilog="This text will be shown after the help")

    # 策略参数
    parser.add_argument("--policy", default="TD3")
    
    # 训练参数
    parser.add_argument("--start_timesteps", default=25e3, type=int)
    parser.add_argument("--max_timesteps", default=1e6, type=int)
    parser.add_argument("--target_exploration_steps", default=10e3, type=int)
    
    # 文件路径参数
    parser.add_argument("--training_pcb", required=False, default=None)
    parser.add_argument("--evaluation_pcb", required=False, default=None)
    
    # 权重参数
    parser.add_argument("-w", required=False, type=np.float32, default=1.0)
    parser.add_argument("--hpwl", required=False, type=np.float32, default=1.0)
    parser.add_argument("-o", required=False, type=np.float32, default=1.0)
    
    # 新增：PCB保存频率参数
    parser.add_argument("--pcb_save_freq", required=False, type=int, default=None,
                        help="保存实时PCB文件的频率（训练步数间隔）")
```

### 3.3 参数设置和验证
```python
def configure_seed(args):
    if (args.auto_seed is True) and (args.seed is None):
        # 自动生成种子
        args.seed = [np.random.randint(0, 2**32-1) for _ in range(args.runs)]
    elif args.seed is None:
        # 使用默认种子
        args.seed = [42 for _ in range(args.runs)]
```

### 3.4 训练运行函数
```python
def training_run(settings):
    # 设置随机种子
    setup_seed(seed=settings["seed"][settings["run"]])
    
    # 创建日志目录
    settings["log_dir"] = os.path.join(settings["tensorboard_dir"],
                                       settings["run_name"] + f'_{settings["run"]}_{settings["policy"]}')
    
    # 确保目录存在
    if not os.path.isdir(settings["tensorboard_dir"]):
        os.makedirs(settings["tensorboard_dir"])
    if not os.path.isdir(settings["log_dir"]):
        os.makedirs(settings["log_dir"])
    
    # 加载超参数
    hp = load_hyperparameters_from_file(settings["hyperparameters"])
```

### 3.5 环境参数配置
```python
env_params = parameters({
    "pcb_file": settings["training_pcb"],
    "training_pcb": settings["training_pcb"],
    "evaluation_pcb": settings["evaluation_pcb"],
    "net": "",
    "use_dataAugmenter": True,
    "augment_position": True,
    "augment_orientation": True,
    "agent_max_action": 1,
    "agent_expl_noise": hp["expl_noise"],
    "debug": False,
    "max_steps": 200,
    "w": settings["w"],           # 欧几里得距离权重
    "o": settings["o"],           # 重叠惩罚权重
    "hpwl": settings["hpwl"],     # HPWL权重
    "seed": settings["seed"][settings["run"]],
    "ignore_power": True,
    "log_dir": settings["log_dir"],
    "idx": settings["pcb_idx"],
    "shuffle_idxs": settings["shuffle_training_idxs"],
})
```

### 3.6 环境初始化
```python
# 创建环境实例
env = environment(env_params)
env.reset()

# 设置模型
model = setup_model(model_type=settings["policy"],
                    train_env=env,
                    hyperparameters=hp,
                    device=settings["device"],
                    early_stopping=settings["early_stopping"],
                    verbose=settings["verbose"])
```

### 3.7 回调函数配置
```python
callback = log_and_eval_callback(
    log_dir=settings["log_dir"],
    settings=settings,
    hyperparameters=hp,
    model=model,
    eval_freq=settings["evaluate_every"],
    verbose=settings["verbose"],
    training_log="training.log",
    num_evaluations=16,
    pcb_save_freq=settings.get("pcb_save_freq", None)  # PCB保存频率参数
)
```

### 3.8 日志记录
```python
# 写入描述日志
write_desc_log(
    full_fn=os.path.join(settings["log_dir"],
                         f'{settings["run_name"]}_desc.log'),
    settings=settings,
    hyperparameters=hp,
    model=model
)
```

## 关键文件

### train.py
- **位置**：`src/training/train.py`
- **功能**：主训练脚本，负责参数解析和训练流程控制

### run_config.py
- **位置**：`src/training/run_config.py`
- **功能**：命令行参数解析和配置管理

## 参数说明

### 训练策略参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--policy` | TD3 | 强化学习算法（SAC/TD3） |
| `--start_timesteps` | 25e3 | 初始随机策略步数 |
| `--max_timesteps` | 1e6 | 最大训练步数 |
| `--target_exploration_steps` | 10e3 | 目标探索步数 |

### 文件路径参数
| 参数 | 说明 |
|------|------|
| `--training_pcb` | 训练PCB文件路径 |
| `--evaluation_pcb` | 评估PCB文件路径 |
| `--hyperparameters` | 超参数配置文件路径 |

### 权重参数
| 参数 | 说明 |
|------|------|
| `-w` | 欧几里得距离权重 |
| `--hpwl` | HPWL权重 |
| `-o` | 重叠惩罚权重 |

## 输出信息
```
Starting training with SAC policy
Training PCB file: /path/to/training.pcb
Evaluation PCB file: /path/to/evaluation.pcb
Log directory: /path/to/work/experiment_xxx
Device: cuda
```

## 下一步
进入[04_PCB文件加载阶段](./04_PCB文件加载阶段.md) 