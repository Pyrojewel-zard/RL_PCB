# 11. 报告生成阶段

## 概述
报告生成阶段负责整合所有训练和评估结果，生成综合性的实验报告，包括性能分析、可视化图表和最佳布局结果。

## 详细流程

### 11.1 报告生成启动

#### 11.1.1 主报告生成函数
```python
def generate_experiment_report(self, work_dir, hyperparameters, report_config, output_path):
    """生成综合实验报告"""
    print("Starting comprehensive report generation...")
    
    # 收集所有实验结果
    experiment_data = self._collect_experiment_data(work_dir)
    
    # 分析训练过程
    training_analysis = self._analyze_training_process(experiment_data)
    
    # 分析评估结果
    evaluation_analysis = self._analyze_evaluation_results(experiment_data)
    
    # 生成可视化
    visualizations = self._generate_comprehensive_visualizations(experiment_data)
    
    # 生成PDF报告
    self._generate_pdf_report(
        training_analysis, 
        evaluation_analysis, 
        visualizations, 
        hyperparameters, 
        output_path
    )
    
    print(f"Comprehensive report generated: {output_path}")
```

### 11.2 实验数据收集

#### 11.2.1 数据收集函数
```python
def _collect_experiment_data(self, work_dir):
    """收集实验数据"""
    experiment_data = {
        'training_logs': [],
        'evaluation_results': [],
        'model_checkpoints': [],
        'pcb_files': [],
        'tensorboard_logs': [],
        'visualization_files': []
    }
    
    # 收集训练日志
    training_log_path = os.path.join(work_dir, "training.log")
    if os.path.exists(training_log_path):
        experiment_data['training_logs'] = self._parse_training_log(training_log_path)
    
    # 收集评估结果
    eval_dir = os.path.join(work_dir, "evaluation")
    if os.path.exists(eval_dir):
        experiment_data['evaluation_results'] = self._collect_evaluation_results(eval_dir)
    
    # 收集模型检查点
    model_dir = os.path.join(work_dir, "models")
    if os.path.exists(model_dir):
        experiment_data['model_checkpoints'] = self._collect_model_checkpoints(model_dir)
    
    # 收集PCB文件
    pcb_dir = os.path.join(work_dir, "realtime_pcb")
    if os.path.exists(pcb_dir):
        experiment_data['pcb_files'] = self._collect_pcb_files(pcb_dir)
    
    # 收集TensorBoard日志
    tb_dir = os.path.join(work_dir, "tensorboard")
    if os.path.exists(tb_dir):
        experiment_data['tensorboard_logs'] = self._collect_tensorboard_logs(tb_dir)
    
    return experiment_data
```

#### 11.2.2 训练日志解析
```python
def _parse_training_log(self, log_path):
    """解析训练日志"""
    training_data = {
        'steps': [],
        'rewards': [],
        'policy_losses': [],
        'value_losses': [],
        'episodes': [],
        'timestamps': []
    }
    
    with open(log_path, 'r') as f:
        for line in f:
            try:
                log_entry = json.loads(line.strip())
                
                training_data['steps'].append(log_entry.get('step', 0))
                training_data['rewards'].append(log_entry.get('reward', 0))
                training_data['policy_losses'].append(log_entry.get('policy_loss', 0))
                training_data['value_losses'].append(log_entry.get('value_loss', 0))
                training_data['episodes'].append(log_entry.get('episodes', 0))
                training_data['timestamps'].append(log_entry.get('timestamp', 0))
                
            except json.JSONDecodeError:
                continue
    
    return training_data
```

### 11.3 训练过程分析

#### 11.3.1 训练分析函数
```python
def _analyze_training_process(self, experiment_data):
    """分析训练过程"""
    training_logs = experiment_data['training_logs']
    
    if not training_logs:
        return {}
    
    analysis = {
        'total_steps': len(training_logs['steps']),
        'final_reward': training_logs['rewards'][-1] if training_logs['rewards'] else 0,
        'best_reward': max(training_logs['rewards']) if training_logs['rewards'] else 0,
        'average_reward': np.mean(training_logs['rewards']) if training_logs['rewards'] else 0,
        'reward_trend': self._calculate_trend(training_logs['rewards']),
        'convergence_analysis': self._analyze_convergence(training_logs),
        'loss_analysis': self._analyze_losses(training_logs),
        'training_duration': self._calculate_training_duration(training_logs)
    }
    
    return analysis
```

#### 11.3.2 收敛性分析
```python
def _analyze_convergence(self, training_logs):
    """分析训练收敛性"""
    rewards = training_logs['rewards']
    
    if len(rewards) < 100:
        return {'converged': False, 'reason': 'Insufficient data'}
    
    # 计算奖励趋势
    recent_rewards = rewards[-100:]  # 最近100步
    early_rewards = rewards[:100]    # 前100步
    
    recent_avg = np.mean(recent_rewards)
    early_avg = np.mean(early_rewards)
    
    # 计算奖励稳定性
    recent_std = np.std(recent_rewards)
    
    convergence_analysis = {
        'converged': recent_std < 0.1 and recent_avg > early_avg,
        'reward_improvement': recent_avg - early_avg,
        'stability': 1.0 / (1.0 + recent_std),
        'final_performance': recent_avg
    }
    
    return convergence_analysis
```

#### 11.3.3 损失分析
```python
def _analyze_losses(self, training_logs):
    """分析损失函数"""
    policy_losses = training_logs['policy_losses']
    value_losses = training_logs['value_losses']
    
    loss_analysis = {
        'policy_loss_trend': self._calculate_trend(policy_losses),
        'value_loss_trend': self._calculate_trend(value_losses),
        'final_policy_loss': policy_losses[-1] if policy_losses else 0,
        'final_value_loss': value_losses[-1] if value_losses else 0,
        'policy_loss_stability': np.std(policy_losses[-50:]) if len(policy_losses) >= 50 else 0,
        'value_loss_stability': np.std(value_losses[-50:]) if len(value_losses) >= 50 else 0
    }
    
    return loss_analysis
```

### 11.4 评估结果分析

#### 11.4.1 评估分析函数
```python
def _analyze_evaluation_results(self, experiment_data):
    """分析评估结果"""
    evaluation_results = experiment_data['evaluation_results']
    
    if not evaluation_results:
        return {}
    
    analysis = {
        'performance_summary': self._summarize_performance(evaluation_results),
        'comparative_analysis': self._compare_experiments(evaluation_results),
        'best_results': self._identify_best_results(evaluation_results),
        'statistical_analysis': self._perform_statistical_analysis(evaluation_results)
    }
    
    return analysis
```

#### 11.4.2 性能总结
```python
def _summarize_performance(self, evaluation_results):
    """总结性能指标"""
    summary = {
        'total_experiments': len(evaluation_results),
        'average_success_rate': np.mean([r.get('success_rate', 0) for r in evaluation_results]),
        'best_success_rate': max([r.get('success_rate', 0) for r in evaluation_results]),
        'average_wirelength': np.mean([r.get('mean_wirelength', 0) for r in evaluation_results]),
        'best_wirelength': min([r.get('mean_wirelength', float('inf')) for r in evaluation_results]),
        'average_hpwl': np.mean([r.get('mean_hpwl', 0) for r in evaluation_results]),
        'best_hpwl': min([r.get('mean_hpwl', float('inf')) for r in evaluation_results])
    }
    
    return summary
```

### 11.5 可视化生成

#### 11.5.1 综合可视化
```python
def _generate_comprehensive_visualizations(self, experiment_data):
    """生成综合可视化"""
    visualizations = {}
    
    # 训练过程可视化
    if experiment_data['training_logs']:
        visualizations['training_curves'] = self._plot_training_curves(experiment_data['training_logs'])
        visualizations['loss_curves'] = self._plot_loss_curves(experiment_data['training_logs'])
        visualizations['reward_distribution'] = self._plot_reward_distribution(experiment_data['training_logs'])
    
    # 评估结果可视化
    if experiment_data['evaluation_results']:
        visualizations['performance_comparison'] = self._plot_performance_comparison(experiment_data['evaluation_results'])
        visualizations['metric_correlation'] = self._plot_metric_correlation(experiment_data['evaluation_results'])
        visualizations['success_rate_analysis'] = self._plot_success_rate_analysis(experiment_data['evaluation_results'])
    
    # PCB布局可视化
    if experiment_data['pcb_files']:
        visualizations['layout_evolution'] = self._plot_layout_evolution(experiment_data['pcb_files'])
        visualizations['best_layout'] = self._visualize_best_layout(experiment_data['pcb_files'])
    
    return visualizations
```

#### 11.5.2 训练曲线绘制
```python
def _plot_training_curves(self, training_logs):
    """绘制训练曲线"""
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    
    # 奖励曲线
    axes[0, 0].plot(training_logs['steps'], training_logs['rewards'], 'b-', alpha=0.7)
    axes[0, 0].set_title('Training Reward Curve')
    axes[0, 0].set_xlabel('Training Steps')
    axes[0, 0].set_ylabel('Reward')
    axes[0, 0].grid(True, alpha=0.3)
    
    # 移动平均奖励
    window_size = 100
    if len(training_logs['rewards']) >= window_size:
        moving_avg = np.convolve(training_logs['rewards'], np.ones(window_size)/window_size, mode='valid')
        axes[0, 1].plot(training_logs['steps'][window_size-1:], moving_avg, 'r-', linewidth=2)
        axes[0, 1].set_title('Moving Average Reward')
        axes[0, 1].set_xlabel('Training Steps')
        axes[0, 1].set_ylabel('Moving Average Reward')
        axes[0, 1].grid(True, alpha=0.3)
    
    # 策略损失
    axes[1, 0].plot(training_logs['steps'], training_logs['policy_losses'], 'g-', alpha=0.7)
    axes[1, 0].set_title('Policy Loss')
    axes[1, 0].set_xlabel('Training Steps')
    axes[1, 0].set_ylabel('Policy Loss')
    axes[1, 0].grid(True, alpha=0.3)
    
    # 价值损失
    axes[1, 1].plot(training_logs['steps'], training_logs['value_losses'], 'm-', alpha=0.7)
    axes[1, 1].set_title('Value Loss')
    axes[1, 1].set_xlabel('Training Steps')
    axes[1, 1].set_ylabel('Value Loss')
    axes[1, 1].grid(True, alpha=0.3)
    
    plt.tight_layout()
    return fig
```

#### 11.5.3 性能比较图
```python
def _plot_performance_comparison(self, evaluation_results):
    """绘制性能比较图"""
    experiments = [r.get('experiment_name', f'Exp_{i}') for i, r in enumerate(evaluation_results)]
    success_rates = [r.get('success_rate', 0) for r in evaluation_results]
    wirelengths = [r.get('mean_wirelength', 0) for r in evaluation_results]
    hpwl_scores = [r.get('mean_hpwl', 0) for r in evaluation_results]
    
    fig, axes = plt.subplots(1, 3, figsize=(18, 6))
    
    # 成功率比较
    axes[0].bar(experiments, success_rates, color='skyblue', alpha=0.7)
    axes[0].set_title('Success Rate Comparison')
    axes[0].set_ylabel('Success Rate')
    axes[0].tick_params(axis='x', rotation=45)
    
    # 线长比较
    axes[1].bar(experiments, wirelengths, color='lightgreen', alpha=0.7)
    axes[1].set_title('Average Wirelength Comparison')
    axes[1].set_ylabel('Wirelength (mm)')
    axes[1].tick_params(axis='x', rotation=45)
    
    # HPWL比较
    axes[2].bar(experiments, hpwl_scores, color='lightcoral', alpha=0.7)
    axes[2].set_title('Average HPWL Comparison')
    axes[2].set_ylabel('HPWL Score')
    axes[2].tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    return fig
```

### 11.6 PDF报告生成

#### 11.6.1 PDF生成函数
```python
def _generate_pdf_report(self, training_analysis, evaluation_analysis, visualizations, hyperparameters, output_path):
    """生成PDF报告"""
    from reportlab.lib.pagesizes import letter, A4
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Image, Table, TableStyle
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    
    doc = SimpleDocTemplate(output_path, pagesize=A4)
    story = []
    styles = getSampleStyleSheet()
    
    # 标题
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=24,
        spaceAfter=30,
        alignment=1  # 居中
    )
    story.append(Paragraph("PCB布局优化强化学习实验报告", title_style))
    story.append(Spacer(1, 20))
    
    # 实验概述
    story.append(Paragraph("实验概述", styles['Heading2']))
    story.append(Spacer(1, 12))
    
    overview_data = [
        ['实验名称', 'PCB布局优化强化学习'],
        ['算法', hyperparameters.get('algorithm', 'SAC')],
        ['训练步数', str(hyperparameters.get('max_timesteps', 'N/A'))],
        ['评估episodes', str(hyperparameters.get('num_evaluations', 'N/A'))],
        ['报告生成时间', datetime.now().strftime('%Y-%m-%d %H:%M:%S')]
    ]
    
    overview_table = Table(overview_data, colWidths=[2*inch, 4*inch])
    overview_table.setStyle(TableStyle([
        ('BACKGROUND', (0, 0), (-1, 0), 'lightblue'),
        ('TEXTCOLOR', (0, 0), (-1, 0), 'black'),
        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
        ('FONTSIZE', (0, 0), (-1, 0), 12),
        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
        ('BACKGROUND', (0, 1), (-1, -1), 'white'),
        ('GRID', (0, 0), (-1, -1), 1, 'black')
    ]))
    story.append(overview_table)
    story.append(Spacer(1, 20))
    
    # 训练过程分析
    if training_analysis:
        story.append(Paragraph("训练过程分析", styles['Heading2']))
        story.append(Spacer(1, 12))
        
        training_summary = [
            ['总训练步数', str(training_analysis.get('total_steps', 'N/A'))],
            ['最终奖励', f"{training_analysis.get('final_reward', 0):.3f}"],
            ['最佳奖励', f"{training_analysis.get('best_reward', 0):.3f}"],
            ['平均奖励', f"{training_analysis.get('average_reward', 0):.3f}"],
            ['是否收敛', '是' if training_analysis.get('convergence_analysis', {}).get('converged', False) else '否']
        ]
        
        training_table = Table(training_summary, colWidths=[2*inch, 4*inch])
        training_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), 'lightgreen'),
            ('TEXTCOLOR', (0, 0), (-1, 0), 'black'),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), 'white'),
            ('GRID', (0, 0), (-1, -1), 1, 'black')
        ]))
        story.append(training_table)
        story.append(Spacer(1, 20))
    
    # 评估结果分析
    if evaluation_analysis:
        story.append(Paragraph("评估结果分析", styles['Heading2']))
        story.append(Spacer(1, 12))
        
        eval_summary = evaluation_analysis.get('performance_summary', {})
        evaluation_summary = [
            ['实验数量', str(eval_summary.get('total_experiments', 'N/A'))],
            ['平均成功率', f"{eval_summary.get('average_success_rate', 0)*100:.1f}%"],
            ['最佳成功率', f"{eval_summary.get('best_success_rate', 0)*100:.1f}%"],
            ['平均线长', f"{eval_summary.get('average_wirelength', 0):.2f} mm"],
            ['最佳线长', f"{eval_summary.get('best_wirelength', 0):.2f} mm"],
            ['平均HPWL', f"{eval_summary.get('average_hpwl', 0):.2f}"],
            ['最佳HPWL', f"{eval_summary.get('best_hpwl', 0):.2f}"]
        ]
        
        evaluation_table = Table(evaluation_summary, colWidths=[2*inch, 4*inch])
        evaluation_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), 'lightcoral'),
            ('TEXTCOLOR', (0, 0), (-1, 0), 'black'),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), 'white'),
            ('GRID', (0, 0), (-1, -1), 1, 'black')
        ]))
        story.append(evaluation_table)
        story.append(Spacer(1, 20))
    
    # 添加可视化图表
    if visualizations:
        story.append(Paragraph("可视化结果", styles['Heading2']))
        story.append(Spacer(1, 12))
        
        for name, fig in visualizations.items():
            if fig:
                # 保存图表为临时文件
                temp_path = f"/tmp/{name}.png"
                fig.savefig(temp_path, dpi=300, bbox_inches='tight')
                
                # 添加到PDF
                img = Image(temp_path, width=6*inch, height=4*inch)
                story.append(img)
                story.append(Spacer(1, 12))
    
    # 生成PDF
    doc.build(story)
```

### 11.7 报告配置

#### 11.7.1 报告配置文件
```python
def create_report_config(self, experiment_dir):
    """创建报告配置文件"""
    config = {
        'experiment_name': os.path.basename(experiment_dir),
        'report_title': 'PCB布局优化强化学习实验报告',
        'sections': [
            'experiment_overview',
            'training_analysis', 
            'evaluation_results',
            'visualizations',
            'conclusions'
        ],
        'visualization_settings': {
            'figure_size': (12, 8),
            'dpi': 300,
            'style': 'seaborn-v0_8',
            'color_palette': 'viridis'
        },
        'output_settings': {
            'pdf_format': True,
            'html_format': False,
            'include_raw_data': True,
            'compression': True
        }
    }
    
    config_path = os.path.join(experiment_dir, 'report_config.json')
    with open(config_path, 'w') as f:
        json.dump(config, f, indent=2)
    
    return config_path
```

## 关键数据结构

### ExperimentData类
- **功能**：实验数据集合
- **包含**：训练日志、评估结果、模型检查点等

### TrainingAnalysis类
- **功能**：训练过程分析
- **包含**：收敛性、损失分析、性能趋势等

### EvaluationAnalysis类
- **功能**：评估结果分析
- **包含**：性能总结、比较分析、最佳结果等

### VisualizationSet类
- **功能**：可视化集合
- **包含**：训练曲线、性能比较、布局可视化等

## 输出信息
```
[INFO] Starting comprehensive report generation...
[INFO] Collected training data: 600000 steps
[INFO] Collected evaluation data: 16 episodes
[INFO] Generated training curves visualization
[INFO] Generated performance comparison charts
[INFO] Generated layout evolution visualization
[INFO] PDF report generated: /path/to/experiment_report.pdf
[INFO] Report generation completed successfully
```

## 下一步
进入[12_实验总结阶段](./12_实验总结阶段.md) 